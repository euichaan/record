# 선착순 예매 시스템 아키텍처
RDB 스케일 아웃하기 힘들고, 스케일 업의 비용이 크다.  
  
요구사항  
- 동시 요청이 매우 많은 상황  
- 순서가 보장되어야 한다. (먼저 들어온 사람이 먼저 예매가 가능해야 한다)  
- 정해진 자리보다 초과로 예매할 수 없다.  
- 중복 예매는 불가능하다.  
- 3분이 지나면 예매를 할 수 없다.  
  
1. 대기열 등록  
2. 예매할 수 있는 곳으로 입장  
3. 예매 처리  
  
## 1. 대기열 등록 - 대기열 서버
Redis의 ZSET을 사용한다. (API 뒷단)  
API에서 UUID 라는 식별자값을 만들어서(아직 로그인 전) Redis의 ZSET에 저장한다. (UUID, timestamp)  
API는 Redis에 넣고 나서 바로 응답한다. 사용자는 다음 요청부터는 UUID를 가지고 요청한다.  
그 이후 브라우저와 API는 보통 폴링, SSE, WebSocket 중의 하나를 사용해서 대기열을 확인한다.  
  
## 2. 예매할 수 있는 곳으로 입장
스케줄러에서 Redis에 있는 데이터를 Active User에 저장한다.  
사용자가 Active User에 있을 경우 예매 서버로 보낸다.  
  
Redis에서 사용자가 몇 번째에 있는지 보여주는 (점점 줄어드는) 연산을 ZRANK, 전체 대기자 수는 ZCARD로 빠르게 구할 수 있다.   
  
## 3. 예매 처리 - 예매 서버
사용자가 예매를 하면 Redis Lua Script를 통해 원자적으로 처리한다.  
잔여 좌석이 충분하면 DB로 데이터를 쌓거나, MQ로 보내서 Worker가 동작해서 DB로 저장할 수 있다.  
  