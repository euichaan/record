# 외부 연동이 문제일 때 살펴봐야 할 것들
A은행은 새로운 서비스 오픈을 앞두고 사용자 기대감을 높이고 있었고, 대규모 서비스 경험이 있는 개발팀이 있어 오픈 시점에 몰릴 트래픽 처리에도 자신감이 있었다. 하지만 A은행은 오픈과 동시에 장애를 겪었다.  
  
A은행은 가입 과정에서 필요한 정보 인증을 위해 외부 서비스를 호출했는데, 이 외부 서비스가 몰려드는 트래픽을 감당하지 못하면서 장애가 발생한 것이다.  
  
연동 서비스의 문제를 완전히 차단하기는 어렵다. 연동 서비스가 필수인 경우도 있기 때문이다. 하지만 그 영향은 줄일 수 있다.  
- 타임아웃과 재시도  
- 동시 요청 제한과 서킷브레이커  
- DB와 외부 연동  
- HTTP 커넥션 풀  
- 이중화  
## 타임아웃
연동 서비스를 호출할 때 타임아웃을 적절히 설정하지 않으면, 연동 서비스에 장애가 발생했을 때 전체 서비스의 품질이 급격히 나빠질 수 있다.  
```
A 서비스는 톰캣을 사용하고 있으며 스레드 풀 크기는 200이다. 즉, A서비스는 동시에 200개의 요청을 처리할 수 있다.  
A 서비스는 B 서비스를 호출한다.  
B 서비스에 성능 문제가 생겨 응답 시간이 60초를 넘기기 시작했다.  
```
200명이 A 서비스에 요청을 보내고, 200개의 요청이 동시에 처리되고 있고 모두 B 서비스의 응답을 기다리고 있다.  
10초 후, A 서비스에 새로운 100명이 요청을 보낸다. 하지만 A 서비스의 기존 200개 스레드는 아직 응답 대기 중이므로 새로 들어온 요청은 처리가 되지 않는다. A 서비스는 앞선 요청이 끝나야 새로운 요청을 처리할 수 있다. 그러나 B 서비스가 응답하지 않기 때문에 대기는 끝나지 않고 서비스는 마비된다.  
  
또한 사용자는 응답이 올 때 까지 기다리지 않는다. 새로 고침과 같은 방법으로 새로운 요청을 보낸다. -> 이는 문제를 더 악화시킨다. 사용자 입장에서는 앞서 보낸 요청을 취소한 것이지만 A 서비스는 그 사실을 바로 인지하지 못한다. 앞서 사용자가 보낸 요청을 여전히 처리 중이다. 이 상태에서 새로운 요청이 하나 더 들어오게 된다. 즉, 서버가 받는 부하가 배가 되는 상황이 발생한다.  
  
이런 문제를 완화할 수 있는 방법 중 하나는 연동에 대해 타임아웃을 지정하는 것이다.  
    
[Connection timeout, Read timeout](https://alden-kang.tistory.com/20)  
처음 연동하는 서비스라면 타임아웃 시간을 아래와 같이 설정한 뒤, 추이를 보면서 조정하는 것이 좋다.  
- 연결 타임아웃: 3초 ~ 5초  
- 읽기 타임아웃: 5초 ~ 30초  
  
읽기 타임아웃이 다소 길게 느껴질 수 있다. 하지만 처음부터 1~3초 정도로 짧게 설정하면 타임아웃 에러가 자주 발생할 수 있다. **게다가 타임아웃 시간이 너무 짧으면 연동 서비스가 정상 처리했음에도 불구하고 타임아웃 에러가 발생할 수 있다.** 각 흐름은 다음과 같다.  
1. 고객은 상품 결제를 커머스 서버에 요청한다.  
2. 커머스 서버는 승인 처리를 위해 PG 서버 API를 호출한다. 이때 읽기 타임아웃을 5초로 지정한다.  
3. PG 서버는 카드 결제를 위해 카드사 시스템과 통신을 시작한다. 카드사가 승인 처리하는데 5초 이상 걸린다.  
4. 커머스 서버는 PG 서버로부터 5초 동안 응답을 받지 못해 타임아웃 에러가 발생하며 상품 결제에 실패한다.  
5. 커머스 서버는 고객에게 실패 응답을 전송한다.  
6. 카드사 서버는 10초 만에 결제 승인에 성공하고 그 결과를 PG 서버에 응답한다.  
  
이 과정이 끝나면 고객은 카드로는 결제했지만 상품은 구매하지 못하는 불쾌한 상황에 빠진다. 결제처럼 민감한 기능은 타임아웃 시간을 약간 길게 설정해서 간헐적으로 연동 시간이 길어지더라도 정상적으로 처리할 수 있어야 한다.  