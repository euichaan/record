# 다중화
## 다중화의 기본
다중화란, 장애가 발생해도 예비 운용장비로 시스템의 기능을 계속할 수 있도록 하는 것을 말한다.  
시스템의 다중화란 다음의 단계를 실천하는 것이다.  
1. 장애를 상정한다.  
2. 장애에 대비해서 예비 운용장비를 준비한다.  
3. 장애가 발생했을 때 예비 운용장비로 교체할 수 있는 운용체제를 정비한다.  
  
예비 운용장비는 보통 사용하지 않고 현재 운용장비에 장애가 발생하면 예비 운용장비를 연결하는 운용체제를 Cold Standby라고 한다.  
다중화된 시스템에서는 현재 운용장비와 예비 운용장비의 구성을 항상 같은 상태로 해두는 것이 정석이다.  
  
라우터의 경우, Cold Standby로의 운용은 현실적인 선택방법 중 하나이다.  
그러나 웹 서버의 경우 다양한 갱신작업을 보통 중지되어 있는 예비 운용장비에 계속 수행하는 것은 곤란하다. 따라서 현재 운용장비의 내용을 갱신할 때에는 예비 운용장비에도 동일하게 갱신될 수 있도록 운용한다.  
  
두 대의 서버를 항상 가동시켜 두고 늘 같은 상태로 유지해두는 운용 형태를 Hot Standby라고 한다. Cold Standby의 경우는 물리적으로 회선연결을 변경하거나 전원을 투입해야 하기 때문에 장애시의 다운타임이 길어지기 쉽지만, Hot Standby라면 즉시 교체하는 것이 가능하다.  
  
현재 운용장비에 장애가 발생했을 때 자동적으로 예비 운용장비로 처리를 인계하는 것을 장애극복이라고 한다.  
서버를 장애극복하기 위해서는 가상 IP주소(Virtual IP Address)와 IP주소 인계를 사용한다.  
  
정상적으로 장애극복하기 위해서는 현재 운용장비에서 장애가 발생하고 있음을 검출하는 방법이 필요하다. 이 방법을 헬스체크라고 한다.  
웹 서버의 장애를 검출하기 위해서는 실제로 HTTP로 요청을 보내서 응답이 있는지를 확인하는 것이 가장 확실한 방법이다.  

셸스크립트를 통한 Active/Backup 구성을 다음과 같이 만들 수 있다.
```bash
#!/bin/sh
VIP="10.0.0.1"
DEV="eth0"

healthCheck() {
  ping -c 1 -w 1 $VIP >/dev/null
  return $?
}

ip_takeover() {
  MAC=`ip link show $DEV | egrep -o '([0-9a-f]{2}:){5}[0-9a-f]{2}' | head -n 1 | tr -d :`
  ip addr add $VIP/24 dev $DEV
  send_arp $VIP $MAC 255.255.255.255 ffffffffffff
}

while healthCheck; do
  echo "health ok!"
  sleep 1
done
echo "fail over!"
ip_takeover
```
두 대의 서버에 같은 IP주소를 할당하고 다른 머신에서 ping을 계속 날리면서 LAN 케이블을 차례로 빼고 꽂았을 때 아무리 케이블을 바꿔 꽂아도 어느 한 서버에만 ping이 전송됨을 알 수 있다.  
  
이는 주로 ARP(Address Resolution Protocol)과 관련이 있다. 네트워크에서 IP 주소는 논리적 주소이고, 물리적 네트워크 장치는 MAC 주소를 통해 실제로 통신을 하게 된다.  
  
LAN의 세계에서는 IP주소가 아닌 NIC에 고정적으로 할당되어 있는 MAC주소를 사용해서 통신한다. 다른 서버에 패킷을 보낼 때는 MAC 주소를 얻기 위해 ARP 프로토콜을 사용한다. ARP는 IP주소를 지정해서 MAC주소를 조회하는 프로토콜이다. 통신할 때 마다 조회를 하는 것은 효율이 좋지 않으므로, 한번 얻은 MAC 주소는 ARP 테이블에 저장해서 일정시간 캐싱한다. 따라서, 다른 서버에 같은 IP주소가 할당되더라도 ARP테이블이 갱신될 때까지는 그 서버와 통신할 수 없다. 즉, IP주소를 인계하기 위해서는 다른 서버의 ARP테이블을 갱신해주어야만 한다.  
  
그 방법으로 gratuitous ARP가 있다. 통상의 ARP 요청은 이 'IP주소에 대응하는 MAC주소를 알려주기 바람'과 같이 질의하기 위한 것이지만, gratuitous ARP는 '내 IP주소와 MAC주소는 이것이다'라고 다른 서버에 통지하기 위한 것이다.  
  
여러 대의 서버에 처리를 분산시켜 사이트 전체의 확장성을 향상시키는 방법을 부하분산(Load Balance)이라고 한다. 웹 서버를 부하분산 구성으로 하면 접속수가 늘어나서 서버의 처리가 따라가지 못하더라도 서버를 증설함으로써 대응할 수 있게 된다.